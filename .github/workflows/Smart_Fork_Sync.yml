name: Smart Fork Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ£€æŸ¥

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # åªè¯»æƒé™

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure upstream
        run: |
          git remote add upstream https://github.com/Fansirsqi/Sesame-TK.git || true
          git fetch --all

      - name: Check sync status
        id: check
        run: |
          if [ $(git rev-parse main) = $(git rev-parse upstream/main) ]; then
            echo "status=up_to_date" >> $GITHUB_OUTPUT
            echo "âœ… åˆ†æ”¯å·²æ˜¯æœ€æ–°"
          else
            echo "status=needs_update" >> $GITHUB_OUTPUT
            echo "ğŸ”„ éœ€è¦åŒæ­¥æ›´æ–°"
          fi

      - name: Backup protected files (ä»…éœ€æ›´æ–°æ—¶)
        if: steps.check.outputs.status == 'needs_update'
        run: |
          mkdir -p .sync_backup
          [ -d .github/workflows/ ] && cp -R .github/workflows/ .sync_backup/
          [ -f README.md ] && cp README.md .sync_backup/

      - name: Perform sync (ä»…éœ€æ›´æ–°æ—¶)
        if: steps.check.outputs.status == 'needs_update'
        run: |
          git checkout -B main upstream/main --force
          [ -d .sync_backup/workflows ] && {
            rm -rf .github/workflows
            mv .sync_backup/workflows .github/
          }
          [ -f .sync_backup/README.md ] && mv .sync_backup/README.md ./
          rm -rf .sync_backup

      - name: Post-sync status
        run: |
          echo "=== æœ€ç»ˆçŠ¶æ€ ==="
          git status
          echo "ä¿ç•™æ–‡ä»¶æ ¡éªŒ:"
          [ -d .github/workflows/ ] && ls -la .github/workflows/
          [ -f README.md ] && ls -la README.md
